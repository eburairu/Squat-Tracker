# Spec-016: バディシステム (Buddy System)

## 1. 概要
モンスター討伐時に確率で敵を仲間にし、一緒に戦うことができる「バディシステム」を導入する。
収集要素と育成要素を追加することで、ユーザーの継続モチベーションを向上させる。

## 2. 目的
- **継続率向上**: 新しい収集・育成要素により、日々のトレーニングに楽しみを追加する。
- **達成感の強化**: 強敵を仲間にする喜びを提供する。
- **戦略性の拡張**: バディごとの特性（今回はシンプルに追加ダメージのみだが、将来的な拡張性を持たせる）により、攻略の幅を広げる。

## 3. 機能要件

### 3.1 バディの獲得 (Taming)
- **トリガー**: ボス討伐時 (`BossBattle.handleDefeat`)。
- **確率**: 一律 5% (定数で管理し調整可能にする)。
- **条件**: すでに同じ種類のバディを所持している場合は獲得できない（重複不可）。
- **演出**: 獲得時にトースト通知を表示する。

### 3.2 バディの効果 (Effect)
- **攻撃支援**: プレイヤーの攻撃時 (`BossBattle.damage`) に、装備中のバディが追加ダメージを与える。
- **ダメージ計算**: `Base Damage + (Level * 2)`
  - 初期実装では、全バディの Base Damage は `3` とする。
  - レベルは `1` 固定（将来的に育成機能を実装予定）。

### 3.3 バディの管理 (Management)
- **保存**: `localStorage` に `squat-tracker-buddy` キーで保存する。
- **一覧表示**: 装備画面 (`#equipment-modal`) に「バディ」タブを追加し、所持バディ一覧を表示する。
- **装備変更**: リストからバディを選択し、「装備」ボタンで切り替える。

### 3.4 UI表示
- **装備モーダル**:
  - タブ切り替え: 「武器」「バディ」
  - バディリスト: アイコン、名前、効果値を表示。未所持のバディは表示しない（またはシルエット表示）。今回は「所持しているもののみ」表示するシンプル実装とする。
- **戦闘画面**:
  - ボスアバターの横（または下）に、装備中のバディの絵文字を表示する。
  - バディがいない場合は何も表示しない。

## 4. データ構造

### 4.1 Buddy Object
```json
{
  "id": "slime",        // モンスターID (ユニーク)
  "name": "スライム",    // 表示名
  "emoji": "💧",        // アイコン
  "level": 1,           // 現在のレベル
  "exp": 0,             // 現在の経験値
  "acquiredAt": 1715400000000 // 獲得日時 (タイムスタンプ)
}
```

### 4.2 BuddyManager State
```json
{
  "buddies": [ ...Buddy Objects... ],
  "currentBuddyId": "slime" // 装備中のバディID (nullなら装備なし)
}
```

## 5. 既存機能への影響
- **BossBattle**:
  - `damage` メソッド改修: バディダメージの加算。
  - `handleDefeat` メソッド改修: ドロップ判定の追加。
  - `render` メソッド改修: バディ表示の追加。
- **InventoryManager**:
  - タブ切り替えロジックの追加。
  - バディリスト描画ロジックの追加。

## 6. テスト計画
- **E2Eテスト**: Playwright を使用。
  - `localStorage` を操作してバディを所持状態にし、装備画面で表示されるか確認。
  - バディを装備し、戦闘画面に表示されるか確認。
  - 攻撃を行い、ダメージログ（もしあれば）やHPの減り方からボーナスが適用されているか確認（厳密な数値検証は難しいので、ロジックの単体テストを重視）。
  - ボス討伐時のドロップ判定をモックして、獲得フローを確認。

## 7. 将来の拡張性（Out of Scope）
- バディのレベルアップ（経験値システム）。
- バディごとの特殊スキル（クリティカル率アップ、ドロップ率アップなど）。
- バディの進化。
