# エンカウンターシステム仕様書 (Dynamic Encounter System)

## 1. 概要
トレーニングの単調さを解消するため、セット間の休憩時間（インターバル）にランダムイベントが発生する「エンカウンターシステム」を導入する。
プレイヤーはイベントに対して行動を選択し、結果として報酬やバフ/デバフを得る。

## 2. 機能要件

### 2.1 イベント発生
- **トリガー**: `startRest()`（休憩開始）が呼ばれたタイミング。
- **発生確率**: 基礎確率 20%（調整可能）。
- **制約**:
    - 最終セットの休憩では発生しない（次のセットがないため）。
    - ボス戦中のみ発生する（現状は常にボス戦だが、将来的に変更ある場合を考慮）。

### 2.2 イベントの種類
1.  **宝箱 (Treasure Chest)**
    - 内容: 鍵がかかっている、または罠があるかもしれない宝箱。
    - 選択肢:
        - 「開ける」: 成功判定あり。成功でアイテム/EXP獲得。失敗で何もなし。
        - 「無視する」: 何も起きない。
2.  **旅の商人 (Traveling Merchant)**
    - 内容: 休憩時間を「対価」としてアイテムやバフを提供する。
    - 選択肢:
        - 「ポーションを買う（休憩-10秒）」: HP回復（ボスHP減少効果を反転させるなど）やテンションUP。
        - 「話を聞く（EXP獲得）」: 小さな経験値獲得。
        - 「立ち去る」: 何もなし。
3.  **謎の石像 (Mysterious Statue)**
    - 内容: 古代の石像が立っている。
    - 選択肢:
        - 「祈る」: ランダムでテンション大幅UP または 小幅DOWN。
        - 「触れる」: 次のセットの攻撃力UP。
        - 「無視する」: 何もなし。

### 2.3 UI仕様
- **モーダル表示**: イベント発生時、画面中央にモーダルウィンドウを表示。
- **タイマー制御**: モーダル表示中はトレーニングタイマー（休憩タイマー）を一時停止する。
- **選択肢**: ボタン形式で表示。選択すると結果が表示され、モーダルが閉じる（または結果確認後に閉じる）。
- **結果表示**: 獲得したアイテムや効果をトーストまたはモーダル内で表示。

## 3. データ構造
イベントデータは `js/data/encounters.json` で管理する。

```json
[
  {
    "id": "treasure_chest_01",
    "title": "古びた宝箱",
    "description": "部屋の隅に古びた宝箱が置いてある。",
    "image": "chest.png",
    "choices": [
      {
        "id": "open",
        "text": "開ける",
        "successRate": 0.8,
        "success": { "type": "item", "value": "random_weapon_low" },
        "failure": { "type": "text", "message": "空っぽだった..." }
      },
      {
        "id": "ignore",
        "text": "無視する",
        "type": "none"
      }
    ]
  }
]
```

## 4. エッジケース
- **通信切断**: オフラインでも動作すること（ローカルデータ）。
- **連打**: 選択肢の連打防止（一度選択したら無効化）。
- **タイマー終了直前**: 休憩残り時間が少ない場合でも、イベントが発生すればタイマーは止まるので問題ない。

## 5. 非機能要件
- **レスポンス**: モーダル表示は即座に行われること。
- **拡張性**: JSONデータの追加のみで新しいイベントを増やせること。
