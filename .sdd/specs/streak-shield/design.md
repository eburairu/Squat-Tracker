# è¨­è¨ˆæ›¸: ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ»ã‚·ãƒ¼ãƒ«ãƒ‰

## 1. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

### 1.1 æ–°è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«: `StreakManager` (`js/modules/streak-manager.js`)
- **è²¬å‹™**: ã‚·ãƒ¼ãƒ«ãƒ‰ä½¿ç”¨å±¥æ­´ã®ç®¡ç†ã€è‡ªå‹•æ¶ˆè²»ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œã€‚
- **ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–**: `localStorage` ã‚­ãƒ¼ `squat-tracker-streak-shield`
  - ãƒ‡ãƒ¼ã‚¿å½¢å¼: `["2023-10-26", "2023-10-28"]` (YYYY-MM-DDå½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—ã®é…åˆ—)

### 1.2 æ—¢å­˜ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ”¹ä¿®

#### `InventoryManager` (`js/modules/inventory-manager.js`)
- **å¤‰æ›´ç‚¹**:
  - `state` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã« `consumables` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ ã€‚
  - `consumables: { streak_shield: 0 }` ã®ã‚ˆã†ã«ã‚¢ã‚¤ãƒ†ãƒ IDã¨å€‹æ•°ã‚’ç®¡ç†ã€‚
  - ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ : `addConsumable(id, amount)`, `useConsumable(id, amount)`, `getConsumableCount(id)`ã€‚
  - UIæç”» (`render`): æ­¦å™¨ãƒªã‚¹ãƒˆã®ä¸‹ã€ã¾ãŸã¯åˆ¥ã‚¿ãƒ–ã«æ¶ˆè²»ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«æ‹¡å¼µã€‚ä»Šå›ã¯ç°¡æ˜“çš„ã«æ­¦å™¨ãƒªã‚¹ãƒˆã®ä¸Šéƒ¨ã¾ãŸã¯ä¸‹éƒ¨ã«ã€Œæ‰€æŒå“ã€ã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ã€‚

#### `utils.js`
- **å¤‰æ›´ç‚¹**:
  - `computeStreak(entries, shieldDates)`: ç¬¬2å¼•æ•°ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«å¤‰æ›´ã€‚
  - ãƒ­ã‚¸ãƒƒã‚¯: æ—¥ä»˜ã‚’é¡ã‚‹ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ã€`entries` ã«ãªã„å ´åˆã§ã‚‚ `shieldDates` ã«å«ã¾ã‚Œã¦ã„ã‚Œã° `streak++` ã™ã‚‹ã€‚

#### `app.js`
- **å¤‰æ›´ç‚¹**:
  - åˆæœŸåŒ–ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã®ä¸­ã§ `StreakManager.init()` ã‚’å‘¼ã¶ã€‚
  - `InventoryManager` ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã€ã‹ã¤ `History` ã®ãƒ­ãƒ¼ãƒ‰å®Œäº†å¾Œã« `StreakManager.checkAutoUse()` ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

#### `AchievementSystem`
- **å¤‰æ›´ç‚¹**:
  - `check` ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ `computeStreak` ã‚’å‘¼ã¶éš›ã€`StreakManager.getHistory()` ã‚’å–å¾—ã—ã¦æ¸¡ã™ã€‚

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

1. **ã‚¢ãƒ—ãƒªèµ·å‹• (`app.js`)**:
   - `InventoryManager.load()` -> æ‰€æŒæ•°å¾©å…ƒ
   - `StreakManager.load()` -> ã‚·ãƒ¼ãƒ«ãƒ‰ä½¿ç”¨æ­´å¾©å…ƒ
   - `loadHistory()` -> ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å±¥æ­´å¾©å…ƒ

2. **è‡ªå‹•æ¶ˆè²»ãƒã‚§ãƒƒã‚¯ (`StreakManager.checkAutoUse`)**:
   - `lastWorkoutDate` (å±¥æ­´ã®æœ€çµ‚æ—¥) ã‚’å–å¾—ã€‚
   - `yesterday` (æ˜¨æ—¥) ã‚’ç®—å‡ºã€‚
   - `yesterday` ã«ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è¨˜éŒ²ãŒãªãã€ã‹ã¤ã‚·ãƒ¼ãƒ«ãƒ‰ä½¿ç”¨æ­´ã‚‚ãªã‘ã‚Œã°ã€ã€Œæ¬ å¸­ã€ã¨åˆ¤å®šã€‚
   - `InventoryManager.getConsumableCount('streak_shield') > 0` ãªã‚‰:
     - `InventoryManager.useConsumable('streak_shield', 1)`
     - `StreakManager.addHistory(yesterday)`
     - `return true` (æ¶ˆè²»ã—ãŸ)
   - `return false`

3. **çµæœé€šçŸ¥**:
   - `true` ãŒè¿”ã£ã¦ããŸã‚‰ `showToast` ã§é€šçŸ¥ã€‚

## 3. UIè¨­è¨ˆ
- **ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªç”»é¢**:
  - ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ã€ŒğŸ›¡ï¸ ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒ»ã‚·ãƒ¼ãƒ«ãƒ‰ x 5ã€ã®ã‚ˆã†ã«è¡¨ç¤ºã€‚
  - ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ç‰¹ã«ä¸è¦ï¼ˆè‡ªå‹•æ¶ˆè²»ã®ã¿ã®ãŸã‚ï¼‰ã€‚èª¬æ˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å‡ºã™ç¨‹åº¦ã€‚
