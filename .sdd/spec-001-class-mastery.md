# 仕様書: クラス・マスタリー・ツリー (Class Mastery Tree)

## 1. 目的
ユーザーに「育成の自由度」と「成長の実感」を提供し、継続率を向上させる。
現状のクラスシステム（自動レベルアップ）を拡張し、ユーザーが能動的に能力を選択・強化できるスキルツリーシステムを導入する。

## 2. ユースケース
- **ユーザー**は、トレーニングを通じてクラス経験値(EXP)を獲得し、レベルアップする。
- **ユーザー**は、レベルアップ時に「スキルポイント(SP)」を獲得する。
- **ユーザー**は、獲得したSPを消費して、スキルツリー上の「ノード」を解放する。
- **ユーザー**は、解放したノードの効果（ステータス上昇やパッシブスキル）を得て、より有利にゲームを進めることができる。

## 3. 機能要件

### 3.1 SP (Skill Point) の獲得
- クラスレベルが 1 上がるごとに 1 SP を獲得する。
- レベル1時点では 0 SP。レベル2で 1 SP。
- 最大レベル（Lv.10）で合計 9 SP を獲得可能とする。

### 3.2 スキルツリーの構造
- 各クラスに個別のスキルツリーを定義する。
- ツリーは複数の「ノード」で構成される。
- ノードには「Tier（階層）」が存在し、上位Tierのノードを解放するには下位Tierの前提ノードが必要となる場合がある。

### 3.3 ノードの種類と効果
- **ステータス強化 (Stat Boost)**
  - 攻撃力 (Attack Multiplier)
  - 経験値獲得量 (EXP Multiplier)
  - クリティカル率 (Critical Rate)
  - クイズ正解ボーナス (Quiz Multiplier)
- **パッシブスキル (Passive Skill)**
  - 特定条件下での追加効果（例：ボス戦で攻撃力UP、特定コンボ数で回復など）
  - ※今回は初期実装としてステータス強化を中心に構成し、パッシブは将来拡張とする。

### 3.4 解放条件
ノードを解放するには以下の条件を全て満たす必要がある：
1. **SP残量**: ノードごとの必要コスト（基本1）以上のSPを所持していること。
2. **前提条件**: 定義された前提ノード（親ノード）が既に解放されていること（ルートノードを除く）。

## 4. データ構造変更
- ユーザーのクラス習得状況（`squat-tracker-class-mastery`）の保存形式を変更する。
  - **Before**: `{ "warrior": 1500, "mage": 200 }` (クラスID: 経験値)
  - **After**:
    ```json
    {
      "warrior": {
        "exp": 1500,
        "unlockedNodes": ["node_atk_1", "node_exp_1"]
      },
      "mage": {
        "exp": 200,
        "unlockedNodes": []
      }
    }
    ```
- 既存データ（数値のみ）からのマイグレーション処理を実装する。

## 5. UI要件
- **クラス詳細画面**:
  - 現在の所持SPを表示する。
  - 「スキルツリー」ボタン、またはタブを表示する。
- **スキルツリー画面**:
  - ノードを階層的（視覚的）に配置して表示する。
  - 解放済み、解放可能、ロック中の状態を色やアイコンで区別する。
  - ノードタップ時に詳細（名称、効果、コスト）を表示し、「習得」ボタンを押下可能にする。
  - SP不足や条件未達の場合は習得ボタンを無効化（または理由を表示）する。

## 6. エッジケース
- **SP不足**: 習得不可。
- **最大レベル到達後**: それ以上SPは増えない。
- **データ移行**: 古い形式のデータが存在する場合、自動的に新形式に変換し、レベルに応じたSPを使用可能な状態にする。
