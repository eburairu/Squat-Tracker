# ワークアウト・プレイリスト機能 (Workout Playlist System) 仕様書

## 1. 目的
ユーザーが複数のトレーニングプリセット（設定）を組み合わせた一連の「プレイリスト」を作成・保存・実行できるようにする。
これにより、「ウォームアップ → メインセット → クールダウン」といった理想的なトレーニングの流れを自動化し、ユーザーの操作負担と判断コストを削減する。

## 2. ユーザー体験 (UX)
1. **作成**: ユーザーは「プレイリスト作成」ボタンを押し、名前を入力し、既存のプリセットから順序を指定してリストを作成する。
2. **選択**: 「マイ・メニュー」または専用の「プレイリスト」タブから、作成したプレイリストを選択する。
3. **実行**: 「スタート」を押すと、最初のセッションが開始される。
4. **自動進行**: セッション（プリセット）が終了すると、自動的に次のセッションの設定がロードされ、開始待機状態（または自動開始設定があれば即時開始）になる。
5. **完了**: 全てのセッションが終了すると、通常の完了画面が表示される。

## 3. 機能要件

### 3.1 データ構造
- `localStorage` キー: `squat-tracker-playlists`
- データ形式:
```json
[
  {
    "id": "uuid-v4-like-string",
    "name": "朝のルーティン",
    "items": [
      {
        "name": "準備運動",
        "settings": { "setCount": 1, "repCount": 10, "restDuration": 10, ... }
      },
      {
        "name": "メインセット",
        "settings": { "setCount": 3, "repCount": 20, "restDuration": 60, ... }
      }
    ],
    "createdAt": "2024-05-20T10:00:00Z"
  }
]
```
- ※ `items` 内の設定はプリセットの参照ではなく、**値のコピー**として保持する（元プリセットの変更・削除の影響を受けないため）。

### 3.2 CRUD機能 (PlaylistManager)
- **作成 (Create)**: 名前とプリセットリストを指定して新規作成。
- **読み込み (Read)**: 全プレイリストの取得、ID指定での取得。
- **更新 (Update)**: 既存プレイリストの編集（名前、構成変更）。
- **削除 (Delete)**: 指定プレイリストの削除。

### 3.3 実行ロジック (WorkoutTimer / App)
- `WorkoutTimer` に以下の状態を追加:
  - `activePlaylist`: 現在実行中のプレイリストオブジェクト（またはnull）。
  - `currentPlaylistIndex`: 現在のセッションインデックス（0〜）。
- **セッション遷移**:
  - 現在のセッション終了時 (`finishWorkout` 相当のタイミング)、`currentPlaylistIndex` をインクリメント。
  - 次のセッションが存在する場合:
    - 設定をロード (`AdventureSystem.applyPreset` 相当)。
    - タイマーをリセット。
    - ユーザーに「次は [セッション名] です」と通知し、開始ボタンを有効化。
  - 最後のセッションの場合:
    - 通常のワークアウト完了処理を行う。

### 3.4 UI要件
- **プレイリスト管理モーダル**:
  - プレイリスト一覧表示。
  - 新規作成・編集フォーム（プリセットの追加・並べ替え・削除）。
- **メイン画面**:
  - プリセット選択プルダウンの隣に「プレイリスト」切り替えボタン、または統合された選択リスト。
  - 実行中: 画面上部などに「プレイリスト再生中: 1/3 [セッション名]」のようなインジケーターを表示。

## 4. 非機能要件
- **永続化**: ブラウザを閉じてもデータが保持されること。
- **堅牢性**: プレイリストデータが破損していてもアプリ全体がクラッシュしないこと。
- **パフォーマンス**: セッション切り替えがスムーズに行われること（UIのちらつきを最小限に）。

## 5. エッジケース
- **空のプレイリスト**: 作成できないようにバリデーションを行う。
- **実行中の編集**: プレイリスト再生中にそのプレイリストを編集しても、現在実行中のインスタンスには影響しない（実行開始時にコピーを持つか、インデックス管理のみにするか検討。今回はメモリ上のコピーで動作させる）。
- **音声操作**: 「次へ」「スキップ」などのコマンドは今回は対象外とするが、将来的には考慮する。

## 6. テスト方針
- **Playwright**:
  - プレイリスト作成、保存、リロード後の存在確認。
  - プレイリスト選択 → 開始 → 1セット目終了 → 2セット目自動ロード のフロー検証。
- **Unit Test (if applicable)**:
  - `PlaylistManager` のデータ操作ロジック。
